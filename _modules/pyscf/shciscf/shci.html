

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pyscf.shciscf.shci &mdash; PySCF 1.7.6 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> PySCF
          

          
          </a>

          
            
            
              <div class="version">
                1.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">1. An overview of PySCF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version.html">2. Version history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">3. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark.html">4. Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">5. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../theory.html">6. Theoretical methods</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../code-rule.html">Code standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop.html">Guidelines for module development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced.html">Miscellaneous</a></li>
</ul>
<p class="caption"><span class="caption-text">API documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Main modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../interface.html">Interfaces</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PySCF</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyscf.shciscf.shci</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyscf.shciscf.shci</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Copyright 2014-2019 The PySCF Developers. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># Author: Sandeep Sharma &lt;sanshar@gmail.com&gt;</span>
<span class="c1">#         James Smith &lt;james.smith9113@gmail.com&gt;</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SHCI solver for CASCI and CASSCF.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">check_call</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">CalledProcessError</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pyscf.tools</span>
<span class="kn">import</span> <span class="nn">pyscf.lib</span>
<span class="kn">from</span> <span class="nn">pyscf.lib</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="kn">import</span> <span class="n">mcscf</span>

<span class="n">ndpointer</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">ndpointer</span>

<span class="c1"># Settings</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyscf.shciscf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyscf</span> <span class="kn">import</span> <span class="n">__config__</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">SHCIEXE</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">__config__</span><span class="p">,</span> <span class="s2">&quot;shci_SHCIEXE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">SHCISCRATCHDIR</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">__config__</span><span class="p">,</span> <span class="s2">&quot;shci_SHCISCRATCHDIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">SHCIRUNTIMEDIR</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">__config__</span><span class="p">,</span> <span class="s2">&quot;shci_SHCIRUNTIMEDIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">MPIPREFIX</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">__config__</span><span class="p">,</span> <span class="s2">&quot;shci_MPIPREFIX&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">SHCIEXE</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">SHCISCRATCHDIR</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;settings.py not found for module shciscf.  Please create </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                         <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;settings.py&quot;</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;settings.py not found&quot;</span><span class="p">)</span>

<span class="c1"># Libraries</span>
<span class="kn">from</span> <span class="nn">pyscf.lib</span> <span class="kn">import</span> <span class="n">load_library</span>

<span class="n">libE3unpack</span> <span class="o">=</span> <span class="n">load_library</span><span class="p">(</span><span class="s2">&quot;libicmpspt&quot;</span><span class="p">)</span>
<span class="c1"># TODO: Organize this better.</span>
<span class="n">shciLib</span> <span class="o">=</span> <span class="n">load_library</span><span class="p">(</span><span class="s2">&quot;libshciscf&quot;</span><span class="p">)</span>

<span class="n">transformDinfh</span> <span class="o">=</span> <span class="n">shciLib</span><span class="o">.</span><span class="n">transformDinfh</span>
<span class="n">transformDinfh</span><span class="o">.</span><span class="n">restyp</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">transformDinfh</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int32</span><span class="p">),</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int32</span><span class="p">),</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">transformRDMDinfh</span> <span class="o">=</span> <span class="n">shciLib</span><span class="o">.</span><span class="n">transformRDMDinfh</span>
<span class="n">transformRDMDinfh</span><span class="o">.</span><span class="n">restyp</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">transformRDMDinfh</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int32</span><span class="p">),</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int32</span><span class="p">),</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">writeIntNoSymm</span> <span class="o">=</span> <span class="n">shciLib</span><span class="o">.</span><span class="n">writeIntNoSymm</span>
<span class="n">writeIntNoSymm</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">fcidumpFromIntegral</span> <span class="o">=</span> <span class="n">shciLib</span><span class="o">.</span><span class="n">fcidumpFromIntegral</span>
<span class="n">fcidumpFromIntegral</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">fcidumpFromIntegral</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">,</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&quot;C_CONTIGUOUS&quot;</span><span class="p">),</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&quot;C_CONTIGUOUS&quot;</span><span class="p">),</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int32</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&quot;C_CONTIGUOUS&quot;</span><span class="p">),</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">r2RDM</span> <span class="o">=</span> <span class="n">shciLib</span><span class="o">.</span><span class="n">r2RDM</span>
<span class="n">r2RDM</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">r2RDM</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ndpointer</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&quot;C_CONTIGUOUS&quot;</span><span class="p">),</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="SHCI"><a class="viewcode-back" href="../../../interface/shciscf.html#pyscf.shciscf.shci.SHCI">[docs]</a><span class="k">class</span> <span class="nc">SHCI</span><span class="p">(</span><span class="n">pyscf</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">StreamObject</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;SHCI program interface and object to hold SHCI program input parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        mol : Mole object</span>
<span class="sd">            Mole object to define the problem size.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nroots : int</span>
<span class="sd">            The number of roots to solve for.</span>
<span class="sd">        sweep_iter : [int]</span>
<span class="sd">            A list of integers that controls what iteration a certain value of</span>
<span class="sd">            sweep_epsilon is used. Similar to the sweep schedule in DMRG.</span>
<span class="sd">        sweep_epsilon : [float]</span>
<span class="sd">            A list of floats that controls the schedule of the $\epsilon_1$ values</span>
<span class="sd">            used in the variational part of the HCI algorithm. </span>
<span class="sd">        davidsonTol : double</span>
<span class="sd">            Numerical tolerance used in the Davidson algorithm while solving the</span>
<span class="sd">            CI problem in HCI.</span>
<span class="sd">        epsilon2 : double</span>
<span class="sd">            The $\epsilon_2$ value used to screen configurations when calculating</span>
<span class="sd">            the perturbative energy correction.</span>
<span class="sd">        epsilon2Large : double</span>
<span class="sd">            Similar to `epsilon2`, but this controls what portion of the perturbative</span>
<span class="sd">            correction is calculated deterministically (when calculating the </span>
<span class="sd">            correction) using semi-stochastic HCI.</span>
<span class="sd">        targetError : double</span>
<span class="sd">            The tolerance for stochastic/semi-stochastic PT correction to the HCI</span>
<span class="sd">            energy.</span>
<span class="sd">        sampleN : int</span>
<span class="sd">            Controls the number of variational configurations sampled at a time</span>
<span class="sd">            during the stochastic/semi-stochastic PT correction to the HCI energy.</span>
<span class="sd">        restart : bool</span>
<span class="sd">            Tells Dice to restart a calculation using a previously calculated</span>
<span class="sd">            hamiltonian and set of configurations.</span>
<span class="sd">        fullrestart : bool</span>
<span class="sd">            Tells Dice to restart a calculations uing a previously calculated set</span>
<span class="sd">            of configurations, the Hamiltonian is recalculated.</span>
<span class="sd">        dE : double</span>
<span class="sd">            The energy tolerance used to control convergence during the variational</span>
<span class="sd">            HCI algorithm.</span>
<span class="sd">        scratchDirectory : string</span>
<span class="sd">            The path where the *.bkp files and RDM files from Dice will be stored.</span>
<span class="sd">            Previously this option was called prefix.</span>
<span class="sd">        stochastic : bool</span>
<span class="sd">            Controls whether the perturbative energy correction is calculated</span>
<span class="sd">            deterministically or stochastically/semi-stochastically.</span>
<span class="sd">        nPTiter : int</span>
<span class="sd">            The maximum number of iterations for the stochastic/semi-stochastic</span>
<span class="sd">            PT energy correction.</span>
<span class="sd">        DoRDM : bool</span>
<span class="sd">            Whether or not to write the spin 1-RDM along with the spatial 1- and </span>
<span class="sd">            2-RDMS to txt. This is required for HCISCF calculations.</span>
<span class="sd">        groupname : str</span>
<span class="sd">            groupname, orbsym together can control whether to employ symmetry in</span>
<span class="sd">            the calculation.  &quot;groupname = None and orbsym = []&quot; requires the</span>
<span class="sd">            SHCI program using C1 symmetry.</span>
<span class="sd">        useExtraSymm : False</span>
<span class="sd">            if the symmetry of the molecule is Dooh or Cooh, then this keyword uses</span>
<span class="sd">            complex orbitals to make full use of this symmetry</span>
<span class="sd">        initialStates: [[int]]</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; from pyscf import gto, scf, mcscf</span>
<span class="sd">        &gt;&gt;&gt; from pyscf.shciscf import shci</span>
<span class="sd">        &gt;&gt;&gt; mol = gto.M(verbose=4, atom=&quot;O 0 0 0; O 0 0 1.208&quot;)</span>
<span class="sd">        &gt;&gt;&gt; mf = scf.RHF(mol).run()</span>
<span class="sd">        &gt;&gt;&gt; mc = mcscf.CASSCF(mf, 8, 12)</span>
<span class="sd">        &gt;&gt;&gt; mc.fcisolver = shci.SHCI(mol)</span>
<span class="sd">        &gt;&gt;&gt; mc.fcisolver.mpiprefix = &quot;mpirun -np 2&quot;</span>
<span class="sd">        &gt;&gt;&gt; mc.fcisolver.stochastic = True</span>
<span class="sd">        &gt;&gt;&gt; mc.fcisolver.nPTiter = 0  # Turn off perturbative calc.</span>
<span class="sd">        &gt;&gt;&gt; mc.fcisolver.sweep_iter = [0]</span>
<span class="sd">        &gt;&gt;&gt; mc.fcisolver.sweep_epsilon = [5e-3]</span>
<span class="sd">        &gt;&gt;&gt; mc.kernel()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxM</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_thrds</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span>
        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">NOTE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">stdout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputlevel</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SHCIEXE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SHCISCRATCHDIR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpiprefix</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MPIPREFIX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">integralFile</span> <span class="o">=</span> <span class="s2">&quot;FCIDUMP&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span> <span class="o">=</span> <span class="s2">&quot;input.dat&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="s2">&quot;output.dat&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;SHCIRUNTIMEDIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SHCIRUNTIMEDIR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extraline</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># TODO: Organize into pyscf and SHCI parameters</span>
        <span class="c1"># Standard SHCI Input parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">davidsonTol</span> <span class="o">=</span> <span class="mf">5.0e-5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon2</span> <span class="o">=</span> <span class="mf">1.0e-7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon2Large</span> <span class="o">=</span> <span class="mf">1000.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetError</span> <span class="o">=</span> <span class="mf">1.0e-4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampleN</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># self.onlyperturbative = False  # TODO RM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullrestart</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dE</span> <span class="o">=</span> <span class="mf">1.0e-8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stochastic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># self.nblocks = 1 # TODO RM</span>
        <span class="c1"># self.excitation = 1000 # TODO RM</span>
        <span class="c1"># self.nvirt = 1e6 # TODO RM</span>
        <span class="c1"># self.singleList = True # TODO RM</span>
        <span class="c1"># self.io = True # TODO RM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nroots</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nPTiter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DoRDM</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_iter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweep_epsilon</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxIter</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_thrds</span> <span class="o">=</span> <span class="n">num_thrds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbsym</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onlywriteIntegral</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbsym</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">symmetry</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">groupname</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">##################################################</span>
        <span class="c1"># don&#39;t modify the following attributes, if you do not finish part of calculation, which can be reused.</span>
        <span class="c1"># DO NOT CHANGE these parameters, unless you know the code in details</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twopdm</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># By default, 2rdm is calculated after the calculations of wave function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shci_extra_keyword</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># For shci advanced user only.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_fourpdm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_threepdm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_nevpt</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># This flag _restart is set by the program internally, to control when to make</span>
        <span class="c1"># SHCI restart calculation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restart</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_schedule</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returnInt</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irrep_nelec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useExtraSymm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialStates</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">generate_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_thrds</span>

    <span class="nd">@threads</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_thrds</span> <span class="o">=</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">dump_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">new_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;******** SHCI flags ********&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;executable             = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;mpiprefix              = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpiprefix</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;scratchDirectory       = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;integralFile           = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integralFile</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;configFile             = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;outputFile             = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;maxIter                = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxIter</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;sweep_iter             = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:&gt;5}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_iter</span><span class="p">])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_iter</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;sweep_epsilon          = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{:&gt;5}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_epsilon</span><span class="p">])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sweep_epsilon</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;nPTiter                = </span><span class="si">%i</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nPTiter</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stochastic             = </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stochastic</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;restart                = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;fullrestart            = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fullrestart</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;num_thrds              = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_thrds</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;memory                 = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># ABOUT RDMs AND INDEXES: -----------------------------------------------------------------------</span>
    <span class="c1">#   There is two ways to stored an RDM</span>
    <span class="c1">#   (the numbers help keep track of creation/annihilation that go together):</span>
    <span class="c1">#     E3[i1,j2,k3,l3,m2,n1] is the way DICE outputs text and bin files</span>
    <span class="c1">#     E3[i1,j2,k3,l1,m2,n3] is the way the tensors need to be written for SQA and ICPT</span>
    <span class="c1">#</span>
    <span class="c1">#   --&gt; See various remarks in the pertinent functions below.</span>
    <span class="c1"># -----------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="SHCI.read_Dice1RDM"><a class="viewcode-back" href="../../../interface/shciscf.html#pyscf.shciscf.shci.SHCI.read_Dice1RDM">[docs]</a>    <span class="k">def</span> <span class="nf">read_Dice1RDM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Reads the spatial 1RDM from Dice in MOs.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">norbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norbs</span><span class="p">,</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)):</span>
            <span class="n">c0</span><span class="p">,</span> <span class="n">d0</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">rdm</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">d0</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rdm</span></div>

<div class="viewcode-block" id="SHCI.read_Dice_spin_1RDM"><a class="viewcode-back" href="../../../interface/shciscf.html#pyscf.shciscf.shci.SHCI.read_Dice_spin_1RDM">[docs]</a>    <span class="k">def</span> <span class="nf">read_Dice_spin_1RDM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Reads the spin 1RDM from Dice in MOs&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">norbs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norbs</span><span class="p">,</span> <span class="n">norbs</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)):</span>
            <span class="n">c0</span><span class="p">,</span> <span class="n">d0</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">rdm</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">d0</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rdm</span></div>

<div class="viewcode-block" id="SHCI.make_rdm1s"><a class="viewcode-back" href="../../../interface/shciscf.html#pyscf.shciscf.shci.SHCI.make_rdm1s">[docs]</a>    <span class="k">def</span> <span class="nf">make_rdm1s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ncas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nelecas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the $\alpha-\alpha$ and $\beta-\beta$ blocks of the spin 1RDM.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        state : np.ndarray</span>
<span class="sd">            Unused, but kept to continuity with `mcscf.CASCI`</span>
<span class="sd">        ncas : int</span>
<span class="sd">            Unused, but kept to continuity with `mcscf.CASCI`</span>
<span class="sd">        nelecas : int</span>
<span class="sd">            Unused, but kept to continuity with `mcscf.CASCI`</span>
<span class="sd">        root : int</span>
<span class="sd">            State to read RDM for, default is 0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple of the $\alpha-\alpha$ and $\beta-\beta$ blocks of the spin 1RDM.</span>
<span class="sd">            E.g. (dm_a, dm_b)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rel_filepath</span> <span class="o">=</span> <span class="s2">&quot;spin1RDM.</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="n">abs_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">,</span> <span class="n">rel_filepath</span><span class="p">)</span>
        <span class="n">dm_ab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_Dice_spin_1RDM</span><span class="p">(</span><span class="n">abs_filepath</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">dm_ab</span><span class="p">[::</span><span class="mi">2</span><span class="p">,</span> <span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">dm_ab</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">make_rdm1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">link_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Avoid calling self.make_rdm12 because it may be overloaded</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_rdm12</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">link_index</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">make_rdm12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">link_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">nelectrons</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nelec</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="n">nelectrons</span> <span class="o">=</span> <span class="n">nelec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nelectrons</span> <span class="o">=</span> <span class="n">nelec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">nelec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># The 2RDMs written by &quot;SHCIrdm::saveRDM&quot; in DICE</span>
        <span class="c1"># are written as E2[i1,j2,k1,l2]</span>
        <span class="c1"># and stored here as E2[i1,k1,j2,l2] (for PySCF purposes)</span>
        <span class="c1"># This is NOT done with SQA in mind.</span>
        <span class="n">twopdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">))</span>
        <span class="n">file2pdm</span> <span class="o">=</span> <span class="s2">&quot;spatialRDM.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="c1"># file2pdm = file2pdm.encode()  # .encode for python3 compatibility</span>
        <span class="n">r2RDM</span><span class="p">(</span><span class="n">twopdm</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">,</span> <span class="n">file2pdm</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

        <span class="c1"># Symmetry addon</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SO3&#39;</span><span class="p">,</span> <span class="s1">&#39;Dooh&#39;</span><span class="p">,</span> <span class="s1">&#39;Coov&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">useExtraSymm</span><span class="p">:</span>
            <span class="n">nRows</span><span class="p">,</span> <span class="n">rowIndex</span><span class="p">,</span> <span class="n">rowCoeffs</span> <span class="o">=</span> <span class="n">DinfhtoD2h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>
            <span class="n">twopdmcopy</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">twopdm</span>
            <span class="n">twopdm</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">twopdm</span>
            <span class="n">transformRDMDinfh</span><span class="p">(</span>
                <span class="n">norb</span><span class="p">,</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">nRows</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">rowCoeffs</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">twopdmcopy</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">twopdm</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">twopdmcopy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># (This is coherent with previous statement about indexes)</span>
        <span class="n">onepdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ikjj-&gt;ki&quot;</span><span class="p">,</span> <span class="n">twopdm</span><span class="p">)</span>
        <span class="n">onepdm</span> <span class="o">/=</span> <span class="n">nelectrons</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">onepdm</span><span class="p">,</span> <span class="n">twopdm</span>

    <span class="k">def</span> <span class="nf">trans_rdm1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statebra</span><span class="p">,</span> <span class="n">stateket</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">link_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans_rdm12</span><span class="p">(</span><span class="n">statebra</span><span class="p">,</span> <span class="n">stateket</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">link_index</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">trans_rdm12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statebra</span><span class="p">,</span> <span class="n">stateket</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">link_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">nelectrons</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nelec</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="n">nelectrons</span> <span class="o">=</span> <span class="n">nelec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nelectrons</span> <span class="o">=</span> <span class="n">nelec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">nelec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">writeSHCIConfFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">executeSHCI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># The 2RDMs written by &quot;SHCIrdm::saveRDM&quot; in DICE</span>
        <span class="c1"># are written as E2[i1,j2,k1,l2]</span>
        <span class="c1"># and stored here as E2[i1,k1,j2,l2] (for PySCF purposes)</span>
        <span class="c1"># This is NOT done with SQA in mind.</span>
        <span class="n">twopdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">))</span>
        <span class="n">file2pdm</span> <span class="o">=</span> <span class="s2">&quot;spatialRDM.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">statebra</span><span class="p">,</span> <span class="n">stateket</span><span class="p">)</span>
        <span class="n">r2RDM</span><span class="p">(</span><span class="n">twopdm</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">,</span> <span class="n">file2pdm</span><span class="p">)</span><span class="o">.</span><span class="n">endcode</span><span class="p">())</span>

        <span class="c1"># (This is coherent with previous statement about indexes)</span>
        <span class="n">onepdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ikjj-&gt;ki&quot;</span><span class="p">,</span> <span class="n">twopdm</span><span class="p">)</span>
        <span class="n">onepdm</span> <span class="o">/=</span> <span class="n">nelectrons</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">onepdm</span><span class="p">,</span> <span class="n">twopdm</span>

    <span class="k">def</span> <span class="nf">make_rdm12_forSQA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">link_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">nelectrons</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nelec</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="n">nelectrons</span> <span class="o">=</span> <span class="n">nelec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nelectrons</span> <span class="o">=</span> <span class="n">nelec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">nelec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># The 2RDMs written by &quot;SHCIrdm::saveRDM&quot; in DICE</span>
        <span class="c1"># are written as E2[i1,j2,k1,l2]</span>
        <span class="c1"># and stored here as E2[i1,k1,j2,l2] (for PySCF purposes)</span>
        <span class="c1"># This is NOT done with SQA in mind.</span>
        <span class="n">twopdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">))</span>
        <span class="n">file2pdm</span> <span class="o">=</span> <span class="s2">&quot;spatialRDM.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="n">r2RDM</span><span class="p">(</span><span class="n">twopdm</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">,</span> <span class="n">file2pdm</span><span class="p">)</span><span class="o">.</span><span class="n">endcode</span><span class="p">())</span>
        <span class="n">twopdm</span> <span class="o">=</span> <span class="n">twopdm</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># (This is coherent with previous statement about indexes)</span>
        <span class="n">onepdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijkj-&gt;ki&quot;</span><span class="p">,</span> <span class="n">twopdm</span><span class="p">)</span>
        <span class="n">onepdm</span> <span class="o">/=</span> <span class="n">nelectrons</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">onepdm</span><span class="p">,</span> <span class="n">twopdm</span>

    <span class="k">def</span> <span class="nf">make_rdm123</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">link_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_threepdm</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">writeSHCIConfFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">DEBUG1</span><span class="p">:</span>
                <span class="n">inFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;SHCI Input conf&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">inFile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">mpisave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpiprefix</span>
            <span class="c1"># self.mpiprefix=&quot;&quot;</span>
            <span class="n">executeSHCI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpiprefix</span> <span class="o">=</span> <span class="n">mpisave</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;......production of RDMs took </span><span class="si">%10.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">DEBUG1</span><span class="p">:</span>
                <span class="n">outFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">outFile</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_threepdm</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">nelectrons</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nelec</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="n">nelectrons</span> <span class="o">=</span> <span class="n">nelec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nelectrons</span> <span class="o">=</span> <span class="n">nelec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">nelec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># The 3RDMs written by &quot;SHCIrdm::save3RDM&quot; in DICE</span>
        <span class="c1"># are written as E3[i1,j2,k3,l3,m2,n1]</span>
        <span class="c1"># and are also stored here as E3[i1,j2,k3,l3,m2,n1]</span>
        <span class="c1"># This is NOT done with SQA in mind.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">threepdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">))</span>
        <span class="n">file3pdm</span> <span class="o">=</span> <span class="s2">&quot;spatial3RDM.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">,</span> <span class="n">file3pdm</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">norb_read</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">assert</span> <span class="n">norb_read</span> <span class="o">==</span> <span class="n">norb</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">linesp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">linesp</span><span class="p">[:</span><span class="mi">6</span><span class="p">]]</span>
                <span class="n">threepdm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>

        <span class="c1"># (This is coherent with previous statement about indexes)</span>
        <span class="n">twopdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijkklm-&gt;ijlm&quot;</span><span class="p">,</span> <span class="n">threepdm</span><span class="p">)</span>
        <span class="n">twopdm</span> <span class="o">/=</span> <span class="n">nelectrons</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">onepdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijjk-&gt;ki&quot;</span><span class="p">,</span> <span class="n">twopdm</span><span class="p">)</span>
        <span class="n">onepdm</span> <span class="o">/=</span> <span class="n">nelectrons</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;......reading the RDM took    </span><span class="si">%10.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">onepdm</span><span class="p">,</span> <span class="n">twopdm</span><span class="p">,</span> <span class="n">threepdm</span>

    <span class="k">def</span> <span class="nf">_make_dm123</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">link_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Note this function does NOT compute the standard density matrix.</span>
<span class="sd">        The density matrices are reordered to match the the fci.rdm.make_dm123</span>
<span class="sd">        function (used by NEVPT code).</span>
<span class="sd">        The returned &quot;2pdm&quot; is :math:`\langle p^\dagger q r^\dagger s\rangle`;</span>
<span class="sd">        The returned &quot;3pdm&quot; is :math:`\langle p^\dagger q r^\dagger s t^\dagger u\rangle`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">onepdm</span><span class="p">,</span> <span class="n">twopdm</span><span class="p">,</span> <span class="n">threepdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_rdm123</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">threepdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mkijln-&gt;ijklmn&quot;</span><span class="p">,</span> <span class="n">threepdm</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">threepdm</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;jk,lm,in-&gt;ijklmn&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">norb</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">norb</span><span class="p">),</span> <span class="n">onepdm</span><span class="p">)</span>
        <span class="n">threepdm</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;jk,miln-&gt;ijklmn&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">norb</span><span class="p">),</span> <span class="n">twopdm</span><span class="p">)</span>
        <span class="n">threepdm</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lm,kijn-&gt;ijklmn&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">norb</span><span class="p">),</span> <span class="n">twopdm</span><span class="p">)</span>
        <span class="n">threepdm</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;jm,kinl-&gt;ijklmn&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">norb</span><span class="p">),</span> <span class="n">twopdm</span><span class="p">)</span>

        <span class="n">twopdm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;iklj-&gt;ijkl&quot;</span><span class="p">,</span> <span class="n">twopdm</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;li,jk-&gt;ijkl&quot;</span><span class="p">,</span> <span class="n">onepdm</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">norb</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">onepdm</span><span class="p">,</span> <span class="n">twopdm</span><span class="p">,</span> <span class="n">threepdm</span>

    <span class="k">def</span> <span class="nf">make_rdm3</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">norb</span><span class="p">,</span>
            <span class="n">nelec</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span>
            <span class="n">link_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bypass</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">cumulantE4</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_threepdm</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">twopdm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DoThreeRDM&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cumulantE4</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extraline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dospinrdm&quot;</span><span class="p">)</span>

            <span class="n">writeSHCIConfFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">DEBUG1</span><span class="p">:</span>
                <span class="n">inFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span>
                <span class="c1"># inFile = os.path.join(self.scratchDirectory,self.configFile)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;SHCI Input conf&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">inFile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">mpisave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpiprefix</span>
            <span class="c1"># self.mpiprefix=&quot;&quot;</span>
            <span class="n">executeSHCI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpiprefix</span> <span class="o">=</span> <span class="n">mpisave</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;......production of RDMs took </span><span class="si">%10.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">DEBUG1</span><span class="p">:</span>
                <span class="n">outFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>
                <span class="c1"># outFile = os.path.join(self.scratchDirectory,self.outputFile)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">outFile</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_threepdm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraline</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">bypass</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># The 3RDMS binary files written by &quot;SHCIrdm::save3RDM&quot; in DICE</span>
        <span class="c1"># are written as E3[i1,j2,k3,l3,m2,n1]</span>
        <span class="c1"># and are stored here as E3[i1,j2,k3,n1,m2,l3]</span>
        <span class="c1"># This is done with SQA in mind.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading binary 3RDM from DICE&quot;</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">,</span> <span class="s2">&quot;spatial3RDM.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.bin&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
            <span class="n">E3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpackE3_DICE</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">norb</span><span class="p">)</span>

        <span class="c1"># The 3RDMs text files written by &quot;SHCIrdm::save3RDM&quot; in DICE</span>
        <span class="c1"># are written as E3[i1,j2,k3,l3,m2,n1]</span>
        <span class="c1"># and are stored here as E3[i1,j2,k3,n1,m2,l3]</span>
        <span class="c1"># This is done with SQA in mind.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading text-file 3RDM&quot;</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">,</span> <span class="s2">&quot;spatial3RDM.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">E3</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">norb</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">linesp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">integral</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">E3</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">],</span> <span class="n">integral</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;......reading the RDM took    </span><span class="si">%10.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">E3</span>

        <span class="c1"># if (filetype == &quot;binary&quot;) :</span>
        <span class="c1">#    fname = os.path.join(&#39;%s/%s/&#39;%(self.scratchDirectory,&quot;node0&quot;), &quot;spatial_threepdm.%d.%d.bin&quot; %(state, state))</span>
        <span class="c1">#    fnameout = os.path.join(&#39;%s/%s/&#39;%(self.scratchDirectory,&quot;node0&quot;), &quot;spatial_threepdm.%d.%d.bin.unpack&quot; %(state, state))</span>
        <span class="c1">#    libE3unpack.unpackE3(ctypes.c_char_p(fname.encode()),</span>
        <span class="c1">#                         ctypes.c_char_p(fnameout.encode()),</span>
        <span class="c1">#                         ctypes.c_int(norb))</span>

    <span class="k">def</span> <span class="nf">make_rdm4</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">norb</span><span class="p">,</span>
            <span class="n">nelec</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span>
            <span class="n">link_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bypass</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_fourpdm</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">twopdm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threepdm</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DoThreeRDM&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DoFourRDM&quot;</span><span class="p">)</span>

            <span class="n">writeSHCIConfFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">DEBUG1</span><span class="p">:</span>
                <span class="n">inFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span>
                <span class="c1"># inFile = os.path.join(self.scratchDirectory,self.configFile)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;SHCI Input conf&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">inFile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">mpisave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpiprefix</span>
            <span class="c1"># self.mpiprefix=&quot;&quot;</span>
            <span class="n">executeSHCI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpiprefix</span> <span class="o">=</span> <span class="n">mpisave</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;......production of RDMs took </span><span class="si">%10.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">DEBUG1</span><span class="p">:</span>
                <span class="n">outFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>
                <span class="c1"># outFile = os.path.join(self.scratchDirectory,self.outputFile)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">outFile</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_fourpdm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_threepdm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extraline</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">bypass</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># The 4RDMS binary files written by &quot;SHCIrdm::save3RDM&quot; in DICE</span>
        <span class="c1"># are written as E4[i1,j2,k3,l4,m4,n3,o2,p1]</span>
        <span class="c1"># and are stored here as E4[i1,j2,k3,l4,p1,o2,n3,m4]</span>
        <span class="c1"># This is done with SQA in mind.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading binary 4RDM from DICE&quot;</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">,</span> <span class="s2">&quot;spatial4RDM.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.bin&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
            <span class="n">E4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpackE4_DICE</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">norb</span><span class="p">)</span>

        <span class="c1"># The 4RDMs text files written by &quot;SHCIrdm::save3RDM&quot; in DICE</span>
        <span class="c1"># are written as E4[i1,j2,k3,l4,m4,n3,o2,p1]</span>
        <span class="c1"># and are stored here as E4[i1,j2,k3,l4,p1,o2,n3,m4]</span>
        <span class="c1"># This is done with SQA in mind.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading text-file 4RDM&quot;</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">,</span> <span class="s2">&quot;spatial4RDM.</span><span class="si">%d</span><span class="s2">.</span><span class="si">%d</span><span class="s2">.txt&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">E4</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">norb</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">linesp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linesp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">integral</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">linesp</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">E4</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">],</span> <span class="n">integral</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;......reading the RDM took    </span><span class="si">%10.2f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">E4</span>

    <span class="k">def</span> <span class="nf">populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">up</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[:</span><span class="n">dim</span><span class="p">]</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">dim</span><span class="p">:]</span>
        <span class="kn">import</span> <span class="nn">itertools</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="n">dim</span><span class="p">):</span>
            <span class="n">updn</span> <span class="o">=</span> <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">dn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
            <span class="n">array</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">updn</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">unpackE2_DICE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">norb</span><span class="p">):</span>
        <span class="c1"># The 2RDMs written by &quot;SHCIrdm::saveRDM&quot; in DICE</span>
        <span class="c1"># are written as E2[i1,j2,k2,l2]</span>
        <span class="c1"># and are stored here as E2[i1,j2,l2,k2]</span>
        <span class="c1"># This is done with SQA in mind.</span>
        <span class="n">fil</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     [fil.seek: How dangerous is that??]&quot;</span><span class="p">)</span>
        <span class="n">fil</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">53</span><span class="p">)</span>  <span class="c1"># HOW DANGEROUS IS THAT ???!?!?!?</span>
        <span class="n">spina</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">spinb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">spinc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">spind</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="s2">&quot;ab&quot;</span>
        <span class="n">E2hom</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="n">E2het</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">norb</span><span class="p">):</span>
            <span class="n">spina</span> <span class="o">=</span> <span class="p">(</span><span class="n">spina</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">spinb</span> <span class="o">=</span> <span class="p">(</span><span class="n">spinb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">norb</span><span class="p">):</span>
                    <span class="n">spinc</span> <span class="o">=</span> <span class="p">(</span><span class="n">spinc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">spind</span> <span class="o">=</span> <span class="p">(</span><span class="n">spind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
                        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">fil</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">spina</span> <span class="o">==</span> <span class="n">spinb</span> <span class="ow">and</span> <span class="n">spina</span> <span class="o">==</span> <span class="n">spinc</span> <span class="ow">and</span> <span class="n">spina</span> <span class="o">==</span> <span class="n">spind</span><span class="p">:</span>
                            <span class="c1"># print &#39;%3i%3i%3i%3i %3i%3i%3i%3i %1s%1s%1s%1s E2hom %13.5e&#39;%(a,b,c,d,A,B,C,D,ab[spina],ab[spinb],ab[spinc],ab[spind],value)</span>
                            <span class="k">if</span> <span class="n">a</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">c</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">E2hom</span><span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">C</span><span class="p">]</span> <span class="o">-=</span> <span class="n">value</span>
                                <span class="n">E2hom</span><span class="p">[</span><span class="n">B</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">]</span> <span class="o">-=</span> <span class="n">value</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">c</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">):</span>
                                <span class="n">E2hom</span><span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                                <span class="n">E2hom</span><span class="p">[</span><span class="n">B</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">C</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                        <span class="k">elif</span> <span class="p">((</span><span class="n">spina</span> <span class="o">==</span> <span class="n">spinb</span> <span class="ow">and</span> <span class="n">spinc</span> <span class="o">==</span> <span class="n">spind</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">spina</span> <span class="o">==</span> <span class="n">spinc</span> <span class="ow">and</span> <span class="n">spinb</span> <span class="o">==</span> <span class="n">spind</span><span class="p">)</span>
                              <span class="ow">or</span> <span class="p">(</span><span class="n">spina</span> <span class="o">==</span> <span class="n">spind</span> <span class="ow">and</span> <span class="n">spinb</span> <span class="o">==</span> <span class="n">spinc</span><span class="p">)):</span>
                            <span class="c1"># print &#39;%3i%3i%3i%3i %3i%3i%3i%3i %1s%1s%1s%1s E2het %13.5e&#39;%(a,b,c,d,A,B,C,D,ab[spina],ab[spinb],ab[spinc],ab[spind],value)</span>
                            <span class="k">if</span> <span class="n">a</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">c</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">E2het</span><span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">C</span><span class="p">]</span> <span class="o">-=</span> <span class="n">value</span>
                                <span class="n">E2het</span><span class="p">[</span><span class="n">B</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">]</span> <span class="o">-=</span> <span class="n">value</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">c</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">):</span>
                                <span class="n">E2het</span><span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                                <span class="n">E2het</span><span class="p">[</span><span class="n">B</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">C</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#    print &#39;%3i%3i%3i%3i %3i%3i%3i%3i %1s%1s%1s%1s NONE  %13.5e&#39;%(a,b,c,d,A,B,C,D,ab[spina],ab[spinb],ab[spinc],ab[spind],value)</span>
                    <span class="n">spind</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">spinc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">spinb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">spina</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">fil</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     [MORE bytes TO READ!]&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     [at least, no more bytes to read!]&quot;</span><span class="p">)</span>
        <span class="c1"># exit(0)</span>
        <span class="n">fil</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">E2hom</span><span class="p">,</span> <span class="n">E2het</span>

    <span class="k">def</span> <span class="nf">unpackE3_DICE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">norb</span><span class="p">):</span>
        <span class="c1"># The 3RDMs written by &quot;SHCIrdm::save3RDM&quot; in DICE</span>
        <span class="c1"># are written as E3[i1,j2,k3,l3,m2,n1]</span>
        <span class="c1"># and are stored here as E3[i1,j2,k3,n1,m2,l3]</span>
        <span class="c1"># This is done with SQA in mind.</span>
        <span class="n">E3</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="n">fil</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     [fil.seek: How dangerous is that??]&quot;</span><span class="p">)</span>
        <span class="c1"># fil.seek(93) # HOW DANGEROUS IS THAT ???!?!?!?</span>
        <span class="n">fil</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">53</span><span class="p">)</span>  <span class="c1"># HOW DANGEROUS IS THAT ???!?!?!?</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                                <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">fil</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
                                <span class="n">E3</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">fil</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     [MORE bytes TO READ!]&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     [at least, no more bytes to read!]&quot;</span><span class="p">)</span>
        <span class="c1"># exit(0)</span>
        <span class="n">fil</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">E3</span>

    <span class="k">def</span> <span class="nf">unpackE4_DICE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">norb</span><span class="p">):</span>
        <span class="c1"># The 4RDMs written by &quot;SHCIrdm::save4RDM&quot; in DICE</span>
        <span class="c1"># are written as E4[i1,j2,k3,l4,m4,n3,o2,p1]</span>
        <span class="c1"># and are stored here as E4[i1,j2,k3,l4,p1,o2,n3,m4]</span>
        <span class="c1"># This is done with SQA in mind.</span>
        <span class="n">E4</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="n">fil</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     [fil.seek: How dangerous is that??]&quot;</span><span class="p">)</span>
        <span class="n">fil</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">53</span><span class="p">)</span>  <span class="c1"># HOW DANGEROUS IS THAT ???!?!?!?</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                                        <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">fil</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
                                        <span class="n">E4</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">fil</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     [MORE bytes TO READ!]&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     [at least, no more bytes to read!]&quot;</span><span class="p">)</span>
        <span class="c1"># exit(0)</span>
        <span class="n">fil</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">E4</span>

<div class="viewcode-block" id="SHCI.clearSchedule"><a class="viewcode-back" href="../../../interface/shciscf.html#pyscf.shciscf.shci.SHCI.clearSchedule">[docs]</a>    <span class="k">def</span> <span class="nf">clearSchedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO Tagged for removal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduleSweeps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduleMaxMs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduleTols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduleNoises</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="SHCI.kernel"><a class="viewcode-back" href="../../../interface/shciscf.html#pyscf.shciscf.shci.SHCI.kernel">[docs]</a>    <span class="k">def</span> <span class="nf">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h1e</span><span class="p">,</span> <span class="n">eri</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">fciRestart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecore</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Approximately solve CI problem for the specified active space.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Warning about behavior of SHCI</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">The `SHCI.prefix` attribute is no longer supported.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;To set the Dice option `prefix` please set the &quot;</span> <span class="o">+</span> <span class="s2">&quot;`SHCI.scratchDirectory` attribute in PySCF</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="ne">FutureWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scratchDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;prefix&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">roots</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roots</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nroots</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fciRestart</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fciRestart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart</span>

        <span class="k">if</span> <span class="s2">&quot;orbsym&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orbsym</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;orbsym&quot;</span><span class="p">]</span>
        <span class="n">writeIntegralFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h1e</span><span class="p">,</span> <span class="n">eri</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">ecore</span><span class="p">)</span>
        <span class="n">writeSHCIConfFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">fciRestart</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">DEBUG1</span><span class="p">:</span>
            <span class="n">inFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;SHCI Input conf&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">inFile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlywriteIntegral</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Only write integral&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">calc_e</span> <span class="o">=</span> <span class="n">readEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">calc_e</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">calc_e</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nroots</span>
            <span class="k">return</span> <span class="n">calc_e</span><span class="p">,</span> <span class="n">roots</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returnInt</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">h1e</span><span class="p">,</span> <span class="n">eri</span>

        <span class="n">executeSHCI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">DEBUG1</span><span class="p">:</span>
            <span class="n">outFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">outFile</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">calc_e</span> <span class="o">=</span> <span class="n">readEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">calc_e</span><span class="p">,</span> <span class="n">roots</span></div>

    <span class="k">def</span> <span class="nf">approx_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h1e</span><span class="p">,</span> <span class="n">eri</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">fciRestart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecore</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">fciRestart</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;orbsym&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orbsym</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;orbsym&quot;</span><span class="p">]</span>
        <span class="n">writeIntegralFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h1e</span><span class="p">,</span> <span class="n">eri</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">ecore</span><span class="p">)</span>
        <span class="n">writeSHCIConfFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">fciRestart</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">DEBUG1</span><span class="p">:</span>
            <span class="n">inFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;SHCI Input conf&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">inFile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">executeSHCI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">DEBUG1</span><span class="p">:</span>
            <span class="n">outFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">outFile</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">calc_e</span> <span class="o">=</span> <span class="n">readEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">roots</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roots</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nroots</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calc_e</span><span class="p">,</span> <span class="n">roots</span>

    <span class="k">def</span> <span class="nf">restart_scheduler_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">envs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">envs</span><span class="p">[</span><span class="s2">&quot;norm_gorb&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shci_switch_tol</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;norm_ddm&quot;</span> <span class="ow">in</span> <span class="n">envs</span>
                                                            <span class="ow">and</span> <span class="n">envs</span><span class="p">[</span><span class="s2">&quot;norm_ddm&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shci_switch_tol</span> <span class="o">*</span> <span class="mi">10</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_restart</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_restart</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">callback</span>

    <span class="k">def</span> <span class="nf">spin_square</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">civec</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nelec</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="n">nelecb</span> <span class="o">=</span> <span class="n">nelec</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">neleca</span> <span class="o">=</span> <span class="n">nelec</span> <span class="o">-</span> <span class="n">nelecb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">neleca</span><span class="p">,</span> <span class="n">nelecb</span> <span class="o">=</span> <span class="n">nelec</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">neleca</span> <span class="o">-</span> <span class="n">nelecb</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">civec</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ss</span><span class="p">,</span> <span class="n">s</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">ss</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">civec</span><span class="p">),</span> <span class="p">[</span><span class="n">s</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">civec</span><span class="p">)</span>

<div class="viewcode-block" id="SHCI.cleanup_dice_files"><a class="viewcode-back" href="../../../interface/shciscf.html#pyscf.shciscf.shci.SHCI.cleanup_dice_files">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_dice_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the files used for Dice communication.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configFile</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integralFile</span><span class="p">))</span></div></div>


<span class="k">def</span> <span class="nf">print1Int</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.X&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">h1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.0e-8</span><span class="p">:</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%16.10g</span><span class="s2"> </span><span class="si">%4d</span><span class="s2"> </span><span class="si">%4d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.Y&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">h1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.0e-8</span><span class="p">:</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%16.10g</span><span class="s2"> </span><span class="si">%4d</span><span class="s2"> </span><span class="si">%4d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.Z&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">h1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.0e-8</span><span class="p">:</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%16.10g</span><span class="s2"> </span><span class="si">%4d</span><span class="s2"> </span><span class="si">%4d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">Z&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">h1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.0e-8</span><span class="p">:</span>
                    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%16.10g</span><span class="s2"> </span><span class="si">%4d</span><span class="s2"> </span><span class="si">%4d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">make_sched</span><span class="p">(</span><span class="n">SHCI</span><span class="p">):</span>

    <span class="n">nIter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">sweep_iter</span><span class="p">)</span>
    <span class="c1"># Check that the number of different epsilons match the number of iter steps.</span>
    <span class="k">assert</span> <span class="n">nIter</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">sweep_epsilon</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nIter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">SHCI</span><span class="o">.</span><span class="n">sweep_iter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">SHCI</span><span class="o">.</span><span class="n">sweep_epsilon</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0e-3</span><span class="p">]</span>

    <span class="n">schedStr</span> <span class="o">=</span> <span class="s2">&quot;schedule &quot;</span>
    <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">eps</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">sweep_iter</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">sweep_epsilon</span><span class="p">):</span>
        <span class="n">schedStr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>

    <span class="n">schedStr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">end</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">schedStr</span>


<span class="k">def</span> <span class="nf">writeSHCIConfFile</span><span class="p">(</span><span class="n">SHCI</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">Restart</span><span class="p">):</span>
    <span class="n">confFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">configFile</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">confFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

    <span class="c1"># Reference determinant section</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#system</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;nocc </span><span class="si">%i</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nelec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">nelec</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">SHCI</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;FakeCISolver&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nelec</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nelec</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">initialStates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">initialStates</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">initialStates</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">initialStates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">irrep_nelec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nelec</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nelec</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pyscf</span> <span class="kn">import</span> <span class="n">symm</span>
            <span class="kn">from</span> <span class="nn">pyscf.dmrgscf</span> <span class="kn">import</span> <span class="n">dmrg_sym</span>
            <span class="kn">from</span> <span class="nn">pyscf.symm.basis</span> <span class="kn">import</span> <span class="n">DOOH_IRREP_ID_TABLE</span>

            <span class="k">if</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">groupname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">orbsym</span> <span class="ow">is</span> <span class="ow">not</span> <span class="p">[]:</span>
                <span class="n">orbsym</span> <span class="o">=</span> <span class="n">dmrg_sym</span><span class="o">.</span><span class="n">convert_orbsym</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">groupname</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">orbsym</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orbsym</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">norb</span>
            <span class="n">done</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">irrep_nelec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="n">irrep</span><span class="p">,</span> <span class="n">nalpha</span><span class="p">,</span> <span class="n">nbeta</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">[</span><span class="n">dmrg_sym</span><span class="o">.</span><span class="n">irrep_name2id</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">groupname</span><span class="p">,</span> <span class="n">k</span><span class="p">)],</span>
                    <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orbsym</span><span class="p">)):</span>  <span class="c1"># loop over alpha electrons</span>
                    <span class="k">if</span> <span class="n">orbsym</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">irrep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">nalpha</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="n">nalpha</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">orbsym</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">irrep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">nbeta</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="n">nbeta</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">nalpha</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of irreps </span><span class="si">%s</span><span class="s2"> in active space = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">nalpha</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of irreps </span><span class="si">%s</span><span class="s2"> alpha electrons = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nbeta</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of irreps </span><span class="si">%s</span><span class="s2"> in active space = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">nbeta</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of irreps </span><span class="si">%s</span><span class="s2"> beta  electrons = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">end</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Handle different cases for FCIDUMP file names/paths</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;orbitals </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">integralFile</span><span class="p">)))</span>

    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;nroots </span><span class="si">%r</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">nroots</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">symmetry</span> <span class="ow">and</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">groupname</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pointGroup </span><span class="si">{</span><span class="n">SHCI</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">groupname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">SHCI</span><span class="p">,</span> <span class="s2">&quot;wfnsym&quot;</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;irrep </span><span class="si">{</span><span class="n">SHCI</span><span class="o">.</span><span class="n">wfnsym</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Variational Keyword Section</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#variational</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Restart</span><span class="p">:</span>
        <span class="n">schedStr</span> <span class="o">=</span> <span class="n">make_sched</span><span class="p">(</span><span class="n">SHCI</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">schedStr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;schedule</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">  </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">sweep_epsilon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;end</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;davidsonTol </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">davidsonTol</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;dE </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">dE</span><span class="p">)</span>

    <span class="c1"># Sets maxiter to 6 more than the last iter in sweep_iter[] if restarted.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Restart</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;maxiter </span><span class="si">%i</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">sweep_iter</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;maxiter 10</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;fullrestart</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Perturbative Keyword Section</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#pt</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">stochastic</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;deterministic </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;nPTiter </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">nPTiter</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;epsilon2 </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">epsilon2</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;epsilon2Large </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">epsilon2Large</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;targetError </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">targetError</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sampleN </span><span class="si">%i</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">sampleN</span><span class="p">)</span>

    <span class="c1"># Miscellaneous Keywords</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#misc</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;io </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">scratchDirectory</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;prefix </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">DoRDM</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DoOneRDM</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DoSpinOneRDM</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DoRDM</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">extraline</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>

    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># SHCI requires that there is an extra line.</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">D2htoDinfh</span><span class="p">(</span><span class="n">SHCI</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">):</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">complex</span><span class="p">)</span>
    <span class="n">nRows</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">norb</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">rowIndex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">norb</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">rowCoeffs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">norb</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">orbsym1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">norb</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">orbsym</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">orbsym</span><span class="p">)</span>
    <span class="c1"># Convert SO3 -&gt; Dooh, see pyscf.symm.basis.so3_irrep_id</span>
    <span class="n">orbsym</span> <span class="o">=</span> <span class="n">orbsym</span> <span class="o">%</span> <span class="mi">100</span>

    <span class="n">A_irrep_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">E_irrep_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">orbsym</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">A_irrep_ids</span><span class="p">)</span>

    <span class="c1"># A1g/A2g/A1u/A2u for Dooh or A1/A2 for Coov</span>
    <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="n">A_irrep_ids</span><span class="p">:</span>
        <span class="n">is_gerade</span> <span class="o">=</span> <span class="n">ir</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbsym</span> <span class="o">==</span> <span class="n">ir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">nRows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">rowIndex</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">rowCoeffs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="n">is_gerade</span><span class="p">:</span>  <span class="c1"># A1g/A2g for Dooh or A1/A2 for Coov</span>
                <span class="n">orbsym1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># A1u/A2u for Dooh</span>
                <span class="n">orbsym1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># See L146 of pyscf/symm/basis.py</span>
    <span class="n">Ex_irrep_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ir</span> <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="n">E_irrep_ids</span> <span class="k">if</span> <span class="p">(</span><span class="n">ir</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="n">Ex_irrep_ids</span><span class="p">:</span>
        <span class="n">is_gerade</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_gerade</span><span class="p">:</span>
            <span class="c1"># See L146 of basis.py</span>
            <span class="n">Ex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbsym</span> <span class="o">==</span> <span class="n">ir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Ey</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbsym</span> <span class="o">==</span> <span class="n">ir</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbsym</span> <span class="o">==</span> <span class="n">ir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Ey</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbsym</span> <span class="o">==</span> <span class="n">ir</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ir</span> <span class="o">%</span> <span class="mi">10</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Ex</span><span class="p">,</span> <span class="n">Ey</span><span class="p">):</span>
            <span class="n">nRows</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">nRows</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">is_gerade</span><span class="p">:</span>
                <span class="n">orbsym1</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">orbsym1</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orbsym1</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">orbsym1</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>

            <span class="n">rowIndex</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ix</span><span class="p">],</span> <span class="n">rowIndex</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span>
            <span class="n">rowIndex</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">iy</span><span class="p">],</span> <span class="n">rowIndex</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span>

            <span class="n">coeffs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="p">],</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">coeffs</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">],</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.0</span><span class="n">j</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">rowCoeffs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ix</span><span class="p">],</span> <span class="n">rowCoeffs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">rowCoeffs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">iy</span><span class="p">],</span> <span class="n">rowCoeffs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">nRows</span><span class="p">,</span> <span class="n">rowIndex</span><span class="p">,</span> <span class="n">rowCoeffs</span><span class="p">,</span> <span class="n">orbsym1</span>


<span class="k">def</span> <span class="nf">DinfhtoD2h</span><span class="p">(</span><span class="n">SHCI</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">):</span>
    <span class="n">nRows</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">norb</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">rowIndex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">norb</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">rowCoeffs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">norb</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">orbsym</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">orbsym</span><span class="p">)</span>
    <span class="c1"># Convert SO3 -&gt; Dooh, see pyscf.symm.basis.so3_irrep_id</span>
    <span class="n">orbsym</span> <span class="o">=</span> <span class="n">orbsym</span> <span class="o">%</span> <span class="mi">100</span>
    <span class="n">A_irrep_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">E_irrep_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">orbsym</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">A_irrep_ids</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="n">A_irrep_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbsym</span> <span class="o">==</span> <span class="n">ir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">nRows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">rowIndex</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">rowCoeffs</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># See L146 of pyscf/symm/basis.py</span>
    <span class="n">Ex_irrep_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ir</span> <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="n">E_irrep_ids</span> <span class="k">if</span> <span class="p">(</span><span class="n">ir</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="n">Ex_irrep_ids</span><span class="p">:</span>
        <span class="n">is_gerade</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_gerade</span><span class="p">:</span>
            <span class="c1"># See L146 of basis.py</span>
            <span class="n">Ex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbsym</span> <span class="o">==</span> <span class="n">ir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Ey</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbsym</span> <span class="o">==</span> <span class="n">ir</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ex</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbsym</span> <span class="o">==</span> <span class="n">ir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Ey</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbsym</span> <span class="o">==</span> <span class="n">ir</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ir</span> <span class="o">%</span> <span class="mi">10</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Ex</span><span class="p">,</span> <span class="n">Ey</span><span class="p">):</span>
            <span class="n">nRows</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">nRows</span><span class="p">[</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="n">rowIndex</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ix</span><span class="p">],</span> <span class="n">rowIndex</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span>
            <span class="n">rowIndex</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">iy</span><span class="p">],</span> <span class="n">rowIndex</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span>

            <span class="n">rowCoeffs</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">ix</span><span class="p">],</span> <span class="n">rowCoeffs</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">ix</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">rowCoeffs</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">iy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">rowCoeffs</span><span class="p">[</span><span class="mi">4</span> <span class="o">*</span> <span class="n">iy</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">nRows</span><span class="p">,</span> <span class="n">rowIndex</span><span class="p">,</span> <span class="n">rowCoeffs</span>


<span class="k">def</span> <span class="nf">writeIntegralFile</span><span class="p">(</span><span class="n">SHCI</span><span class="p">,</span> <span class="n">h1eff</span><span class="p">,</span> <span class="n">eri_cas</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">ecore</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nelec</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
        <span class="n">neleca</span> <span class="o">=</span> <span class="n">nelec</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">nelec</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">nelecb</span> <span class="o">=</span> <span class="n">nelec</span> <span class="o">-</span> <span class="n">neleca</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">neleca</span><span class="p">,</span> <span class="n">nelecb</span> <span class="o">=</span> <span class="n">nelec</span>

    <span class="c1"># The name of the FCIDUMP file, default is &quot;FCIDUMP&quot;.</span>
    <span class="n">integralFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">integralFile</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">pyscf</span> <span class="kn">import</span> <span class="n">symm</span>
    <span class="kn">from</span> <span class="nn">pyscf.dmrgscf</span> <span class="kn">import</span> <span class="n">dmrg_sym</span>

    <span class="k">if</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">groupname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SO3&#39;</span><span class="p">,</span> <span class="s1">&#39;Dooh&#39;</span><span class="p">,</span> <span class="s1">&#39;Coov&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">useExtraSymm</span><span class="p">:</span>
        <span class="n">coeffs</span><span class="p">,</span> <span class="n">nRows</span><span class="p">,</span> <span class="n">rowIndex</span><span class="p">,</span> <span class="n">rowCoeffs</span><span class="p">,</span> <span class="n">orbsym</span> <span class="o">=</span> <span class="n">D2htoDinfh</span><span class="p">(</span><span class="n">SHCI</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>

        <span class="n">newintt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">h1eff</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">newint1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">newintt</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">newint1r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">norb</span><span class="p">,</span> <span class="n">norb</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">norb</span><span class="p">):</span>
                <span class="n">newint1r</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">newint1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
        <span class="n">int2</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">eri_cas</span><span class="p">,</span> <span class="n">norb</span><span class="p">)</span>
        <span class="n">eri_cas</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">int2</span><span class="p">)</span>

        <span class="n">transformDinfh</span><span class="p">(</span>
            <span class="n">norb</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">nRows</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">rowIndex</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">rowCoeffs</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">int2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">eri_cas</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">writeIntNoSymm</span><span class="p">(</span>
            <span class="n">norb</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">newint1r</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">eri_cas</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="n">ecore</span><span class="p">,</span>
            <span class="n">neleca</span> <span class="o">+</span> <span class="n">nelecb</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">orbsym</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">groupname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">orbsym</span> <span class="ow">is</span> <span class="ow">not</span> <span class="p">[]:</span>
            <span class="n">orbsym</span> <span class="o">=</span> <span class="n">dmrg_sym</span><span class="o">.</span><span class="n">convert_orbsym</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">groupname</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">orbsym</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">orbsym</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">norb</span>

        <span class="n">eri_cas</span> <span class="o">=</span> <span class="n">pyscf</span><span class="o">.</span><span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">eri_cas</span><span class="p">,</span> <span class="n">norb</span><span class="p">)</span>
        <span class="c1"># Writes the FCIDUMP file using functions in SHCI_tools.cpp.</span>
        <span class="n">integralFile</span> <span class="o">=</span> <span class="n">integralFile</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>  <span class="c1"># .encode for python3 compatibility</span>
        <span class="n">fcidumpFromIntegral</span><span class="p">(</span>
            <span class="n">integralFile</span><span class="p">,</span>
            <span class="n">h1eff</span><span class="p">,</span>
            <span class="n">eri_cas</span><span class="p">,</span>
            <span class="n">norb</span><span class="p">,</span>
            <span class="n">neleca</span> <span class="o">+</span> <span class="n">nelecb</span><span class="p">,</span>
            <span class="n">ecore</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">orbsym</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">neleca</span> <span class="o">-</span> <span class="n">nelecb</span><span class="p">),</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">executeSHCI</span><span class="p">(</span><span class="n">SHCI</span><span class="p">):</span>
    <span class="n">file1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/shci.e&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">))</span>  <span class="c1"># what?</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file1</span><span class="p">):</span>  <span class="c1"># what?</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file1</span><span class="p">)</span>  <span class="c1"># what?</span>
    <span class="n">inFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">configFile</span><span class="p">)</span>
    <span class="n">outFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">SHCI</span><span class="o">.</span><span class="n">mpiprefix</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">inFile</span><span class="p">))</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2"> 2&gt;&amp;1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">outFile</span><span class="p">)</span>
        <span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># save_output(SHCI)</span>
    <span class="k">except</span> <span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">SHCI</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">err</span>


<span class="c1"># def save_output(SHCI):</span>
<span class="c1">#  for i in range(50):</span>
<span class="c1">#    if os.path.exists(os.path.join(SHCI.runtimeDir, &quot;output%02d.dat&quot;%(i))):</span>
<span class="c1">#      continue</span>
<span class="c1">#    else:</span>
<span class="c1">#      import shutil</span>
<span class="c1">#      shutil.copy2(os.path.join(SHCI.runtimeDir, &quot;output.dat&quot;),os.path.join(SHCI.runtimeDir, &quot;output%02d.dat&quot;%(i)))</span>
<span class="c1">#      shutil.copy2(os.path.join(SHCI.runtimeDir, &quot;%s/shci.e&quot;%(SHCI.scratchDirectory)), os.path.join(SHCI.runtimeDir, &quot;shci%02d.e&quot;%(i)))</span>
<span class="c1">#      #print(&#39;BM copied into &quot;output%02d.dat&quot;&#39;%(i))</span>
<span class="c1">#      #print(&#39;BM copied into &quot;shci%02d.e&quot;&#39;%(i))</span>
<span class="c1">#      break</span>


<span class="k">def</span> <span class="nf">readEnergy</span><span class="p">(</span><span class="n">SHCI</span><span class="p">):</span>
    <span class="n">file1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/shci.e&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">)),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="nb">format</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">nroots</span>
    <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>
    <span class="n">calc_e</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">file1</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">file1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">calc_e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">calc_e</span><span class="p">)</span>


<div class="viewcode-block" id="SHCISCF"><a class="viewcode-back" href="../../../interface/shciscf.html#pyscf.shciscf.shci.SHCISCF">[docs]</a><span class="k">def</span> <span class="nf">SHCISCF</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="n">maxM</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shortcut function to setup CASSCF using the SHCI solver.  The SHCI</span>
<span class="sd">    solver is properly initialized in this function so that the 1-step</span>
<span class="sd">    algorithm can applied with SHCI-CASSCF.</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; mol = gto.M(atom=&#39;C 0 0 0; C 0 0 1&#39;)</span>
<span class="sd">    &gt;&gt;&gt; mf = scf.RHF(mol).run()</span>
<span class="sd">    &gt;&gt;&gt; mc = SHCISCF(mf, 4, 4)</span>
<span class="sd">    &gt;&gt;&gt; mc.kernel()</span>
<span class="sd">    -74.414908818611522</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mc</span> <span class="o">=</span> <span class="n">mcscf</span><span class="o">.</span><span class="n">CASSCF</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span> <span class="o">=</span> <span class="n">SHCI</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">maxM</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
    <span class="c1"># mc.callback = mc.fcisolver.restart_scheduler_() #TODO</span>
    <span class="k">if</span> <span class="n">mc</span><span class="o">.</span><span class="n">chkfile</span> <span class="o">==</span> <span class="n">mc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_chkfile</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="c1"># Do not delete chkfile after mcscf</span>
        <span class="n">mc</span><span class="o">.</span><span class="n">chkfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SHCISCRATCHDIR</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SHCISCRATCHDIR</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SHCISCRATCHDIR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mc</span></div>


<span class="k">def</span> <span class="nf">get_hso1e</span><span class="p">(</span><span class="n">wso</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rp</span><span class="p">):</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hso1e</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">hso1e</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">wso</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">rp</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hso1e</span>


<span class="k">def</span> <span class="nf">get_wso</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nao_nr</span><span class="p">()</span>
    <span class="n">wso</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">natm</span><span class="p">):</span>
        <span class="n">zA</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">atom_charge</span><span class="p">(</span><span class="n">iatom</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">atom_coord</span><span class="p">(</span><span class="n">iatom</span><span class="p">)</span>
        <span class="n">mol</span><span class="o">.</span><span class="n">set_rinv_orig</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">wso</span> <span class="o">+=</span> <span class="n">zA</span> <span class="o">*</span> <span class="n">mol</span><span class="o">.</span><span class="n">intor</span><span class="p">(</span><span class="s2">&quot;cint1e_prinvxp_sph&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># sign due to integration by part</span>
    <span class="k">return</span> <span class="n">wso</span>


<span class="k">def</span> <span class="nf">get_p</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rp</span><span class="p">):</span>
    <span class="n">pLL</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="n">pLS</span> <span class="o">=</span> <span class="n">pLL</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">pSS</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pLL</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pLL</span><span class="p">,</span> <span class="n">pLS</span><span class="p">,</span> <span class="n">pSS</span>


<span class="k">def</span> <span class="nf">get_fso2e_withkint</span><span class="p">(</span><span class="n">kint</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">pLL</span><span class="p">,</span> <span class="n">pLS</span><span class="p">,</span> <span class="n">pSS</span><span class="p">):</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fso2e</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">gsoLL</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lmkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span> <span class="n">pSS</span><span class="p">)</span>
        <span class="n">gsoLS</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mlkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span> <span class="n">pLS</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lmkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span> <span class="n">pLS</span><span class="p">)</span>
        <span class="n">gsoSS</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mnkl,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span> <span class="n">pLL</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mnlk,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span> <span class="n">pLL</span><span class="p">)</span> <span class="o">+</span>
                 <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mlnk,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span> <span class="n">pLL</span><span class="p">))</span>
        <span class="n">fso2e</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsoLL</span> <span class="o">+</span> <span class="n">gsoLS</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">gsoLS</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gsoSS</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">fso2e</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fso2e</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span> <span class="n">rp</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fso2e</span>


<span class="k">def</span> <span class="nf">get_kint2</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nao_nr</span><span class="p">()</span>
    <span class="n">kint</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">intor</span><span class="p">(</span><span class="s2">&quot;int2e_spv1spv2_spinor&quot;</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kint</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_fso2e</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">pLL</span><span class="p">,</span> <span class="n">pLS</span><span class="p">,</span> <span class="n">pSS</span><span class="p">):</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nao_nr</span><span class="p">()</span>
    <span class="n">np</span> <span class="o">=</span> <span class="n">nb</span> <span class="o">*</span> <span class="n">nb</span>
    <span class="n">nq</span> <span class="o">=</span> <span class="n">np</span> <span class="o">*</span> <span class="n">np</span>
    <span class="n">ddint</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">intor</span><span class="p">(</span><span class="s2">&quot;int2e_ip1ip2_sph&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nq</span><span class="p">)</span>
    <span class="n">fso2e</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">))</span>

    <span class="n">ddint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">kint</span> <span class="o">=</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">)</span>
    <span class="n">gsoLL</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lmkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pSS</span><span class="p">)</span>
    <span class="n">gsoLS</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mlkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLS</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lmkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLS</span><span class="p">)</span>
    <span class="n">gsoSS</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mnkl,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLL</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mnlk,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLL</span><span class="p">)</span> <span class="o">+</span>
             <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mlnk,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLL</span><span class="p">))</span>
    <span class="n">fso2e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsoLL</span> <span class="o">+</span> <span class="n">gsoLS</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">gsoLS</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gsoSS</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">fso2e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fso2e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rp</span><span class="p">))</span>

    <span class="n">ddint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">kint</span> <span class="o">=</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">)</span>
    <span class="n">gsoLL</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lmkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pSS</span><span class="p">)</span>
    <span class="n">gsoLS</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mlkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLS</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lmkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLS</span><span class="p">)</span>
    <span class="n">gsoSS</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mnkl,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLL</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mnlk,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLL</span><span class="p">)</span> <span class="o">+</span>
             <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mlnk,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLL</span><span class="p">))</span>
    <span class="n">fso2e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsoLL</span> <span class="o">+</span> <span class="n">gsoLS</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">gsoLS</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gsoSS</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">fso2e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fso2e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rp</span><span class="p">))</span>

    <span class="n">ddint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">kint</span> <span class="o">=</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">)</span>
    <span class="n">gsoLL</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lmkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pSS</span><span class="p">)</span>
    <span class="n">gsoLS</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mlkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLS</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;lmkn,lk-&gt;mn&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLS</span><span class="p">)</span>
    <span class="n">gsoSS</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mnkl,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLL</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mnlk,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLL</span><span class="p">)</span> <span class="o">+</span>
             <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;mlnk,lk&quot;</span><span class="p">,</span> <span class="n">kint</span><span class="p">,</span> <span class="n">pLL</span><span class="p">))</span>
    <span class="n">fso2e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsoLL</span> <span class="o">+</span> <span class="n">gsoLS</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">gsoLS</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gsoSS</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">fso2e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fso2e</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rp</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fso2e</span>


<span class="k">def</span> <span class="nf">get_kint</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">nao_nr</span><span class="p">()</span>
    <span class="n">np</span> <span class="o">=</span> <span class="n">nb</span> <span class="o">*</span> <span class="n">nb</span>
    <span class="n">nq</span> <span class="o">=</span> <span class="n">np</span> <span class="o">*</span> <span class="n">np</span>
    <span class="n">ddint</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">intor</span><span class="p">(</span><span class="s2">&quot;int2e_ip1ip2_sph&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nq</span><span class="p">)</span>

    <span class="n">kint</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nq</span><span class="p">))</span>
    <span class="n">kint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># x = yz - zy</span>
    <span class="n">kint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># y = zx - xz</span>
    <span class="n">kint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddint</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># z = xy - yx</span>
    <span class="k">return</span> <span class="n">kint</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">writeSOCIntegrals</span><span class="p">(</span>
        <span class="n">mc</span><span class="p">,</span>
        <span class="n">ncasorbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">rdm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pictureChange1e</span><span class="o">=</span><span class="s2">&quot;bp&quot;</span><span class="p">,</span>
        <span class="n">pictureChange2e</span><span class="o">=</span><span class="s2">&quot;bp&quot;</span><span class="p">,</span>
        <span class="n">uncontract</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyscf.x2c</span> <span class="kn">import</span> <span class="n">x2c</span><span class="p">,</span> <span class="n">sfx2c1e</span>
    <span class="kn">from</span> <span class="nn">pyscf.lib.parameters</span> <span class="kn">import</span> <span class="n">LIGHT_SPEED</span>

    <span class="n">LIGHT_SPEED</span> <span class="o">=</span> <span class="mf">137.0359895000</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">LIGHT_SPEED</span>

    <span class="k">if</span> <span class="n">uncontract</span><span class="p">:</span>
        <span class="n">xmol</span><span class="p">,</span> <span class="n">contr_coeff</span> <span class="o">=</span> <span class="n">x2c</span><span class="o">.</span><span class="n">X2C</span><span class="p">()</span><span class="o">.</span><span class="n">get_xmol</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xmol</span><span class="p">,</span> <span class="n">contr_coeff</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">rdm1ao</span> <span class="o">=</span> <span class="n">rdm1</span>
    <span class="k">if</span> <span class="n">rdm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rdm1ao</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">mc</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rdm1ao</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">rdm1ao</span> <span class="o">=</span> <span class="n">rdm1ao</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rdm1ao</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">uncontract</span><span class="p">:</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">contr_coeff</span><span class="p">,</span> <span class="n">rdm1ao</span><span class="p">,</span> <span class="n">contr_coeff</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">rdm1ao</span>
    <span class="n">np</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">contr_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">contr_coeff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">hso1e</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span>
    <span class="n">h1e_1c</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rp</span> <span class="o">=</span> <span class="n">sfx2c1e</span><span class="o">.</span><span class="n">SpinFreeX2C</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span><span class="o">.</span><span class="n">get_hxr</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">uncontract</span><span class="o">=</span><span class="n">uncontract</span><span class="p">)</span>

    <span class="c1"># two electron terms</span>
    <span class="k">if</span> <span class="n">pictureChange2e</span> <span class="o">==</span> <span class="s2">&quot;bp&quot;</span><span class="p">:</span>
        <span class="n">h2ao</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">alpha</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">xmol</span><span class="o">.</span><span class="n">intor</span><span class="p">(</span><span class="s2">&quot;cint2e_p1vxp1_sph&quot;</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">aosym</span><span class="o">=</span><span class="s2">&quot;s1&quot;</span><span class="p">))</span>
        <span class="n">h2ao</span> <span class="o">=</span> <span class="n">h2ao</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">)</span>
        <span class="n">hso1e</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijklm,lm-&gt;ijk&quot;</span><span class="p">,</span> <span class="n">h2ao</span><span class="p">,</span> <span class="n">dm</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span>
                        <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijklm, kl-&gt;ijm&quot;</span><span class="p">,</span> <span class="n">h2ao</span><span class="p">,</span> <span class="n">dm</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijklm,mj-&gt;ilk&quot;</span><span class="p">,</span> <span class="n">h2ao</span><span class="p">,</span> <span class="n">dm</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">pictureChange2e</span> <span class="o">==</span> <span class="s2">&quot;x2c&quot;</span><span class="p">:</span>
        <span class="n">dm1</span> <span class="o">=</span> <span class="n">dm</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">pLL</span><span class="p">,</span> <span class="n">pLS</span><span class="p">,</span> <span class="n">pSS</span> <span class="o">=</span> <span class="n">get_p</span><span class="p">(</span><span class="n">dm1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rp</span><span class="p">)</span>
        <span class="c1"># kint = get_kint(xmol)</span>
        <span class="c1"># hso1e += -(alpha)**2*0.5*get_fso2e_withkint(kint,x,rp,pLL,pLS,pSS)</span>
        <span class="n">hso1e</span> <span class="o">+=</span> <span class="o">-</span><span class="p">((</span><span class="n">alpha</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">get_fso2e</span><span class="p">(</span><span class="n">xmol</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">pLL</span><span class="p">,</span> <span class="n">pLS</span><span class="p">,</span> <span class="n">pSS</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pictureChange2e</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">hso1e</span> <span class="o">*=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pictureChange2e</span><span class="p">,</span> <span class="s2">&quot;not a valid option&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># MF 1 electron term</span>
    <span class="k">if</span> <span class="n">pictureChange1e</span> <span class="o">==</span> <span class="s2">&quot;bp&quot;</span><span class="p">:</span>
        <span class="n">hso1e</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">get_wso</span><span class="p">(</span><span class="n">xmol</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pictureChange1e</span> <span class="o">==</span> <span class="s2">&quot;x2c1&quot;</span><span class="p">:</span>
        <span class="n">dm</span> <span class="o">/=</span> <span class="mf">2.0</span>
        <span class="n">pLL</span><span class="p">,</span> <span class="n">pLS</span><span class="p">,</span> <span class="n">pSS</span> <span class="o">=</span> <span class="n">get_p</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rp</span><span class="p">)</span>
        <span class="n">wso</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">get_wso</span><span class="p">(</span><span class="n">xmol</span><span class="p">)</span>
        <span class="n">hso1e</span> <span class="o">+=</span> <span class="n">get_hso1e</span><span class="p">(</span><span class="n">wso</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pictureChange1e</span> <span class="o">==</span> <span class="s2">&quot;x2cn&quot;</span><span class="p">:</span>
        <span class="n">h1e_2c</span> <span class="o">=</span> <span class="n">x2c</span><span class="o">.</span><span class="n">get_hcore</span><span class="p">(</span><span class="n">xmol</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h1e_2c</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0e-8</span><span class="p">:</span>
                    <span class="n">hso1e</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">h1e_2c</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="mf">2.0</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h1e_2c</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0e-8</span><span class="p">:</span>
                    <span class="n">hso1e</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">h1e_2c</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="mf">2.0</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h1e_2c</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0e-8</span><span class="p">:</span>
                    <span class="n">hso1e</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">h1e_2c</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="mf">2.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pictureChange1e</span><span class="p">,</span> <span class="s2">&quot;not a valid option&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">h1ao</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">uncontract</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">h1ao</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">contr_coeff</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">hso1e</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span> <span class="n">contr_coeff</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h1ao</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">hso1e</span>

    <span class="n">ncore</span><span class="p">,</span> <span class="n">ncas</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">ncore</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">ncas</span>
    <span class="k">if</span> <span class="n">ncasorbs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncas</span> <span class="o">=</span> <span class="n">ncasorbs</span>
    <span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">mo_coeff</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;xpq,pi,qj-&gt;xij&quot;</span><span class="p">,</span> <span class="n">h1ao</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)[:,</span> <span class="n">ncore</span><span class="p">:</span><span class="n">ncore</span> <span class="o">+</span> <span class="n">ncas</span><span class="p">,</span> <span class="n">ncore</span><span class="p">:</span><span class="n">ncore</span> <span class="o">+</span> <span class="n">ncas</span><span class="p">]</span>
    <span class="n">print1Int</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="s2">&quot;SOC&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="dryrun"><a class="viewcode-back" href="../../../interface/shciscf.html#pyscf.shciscf.shci.dryrun">[docs]</a><span class="k">def</span> <span class="nf">dryrun</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate FCIDUMP and SHCI input.dat file for a give multiconfigurational </span>
<span class="sd">    object. This method DOES NOT run a single iteration using Dice it just </span>
<span class="sd">    generates all the inputs you&#39;d need to do so.</span>

<span class="sd">    Args:</span>
<span class="sd">        mc: a CASSCF/CASCI object (or RHF object)</span>

<span class="sd">    Kwargs: </span>
<span class="sd">        mo_coeff: `np.ndarray` of the molecular orbital coefficients. </span>
<span class="sd">            Default is None.</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; from pyscf import gto, scf, mcscf</span>
<span class="sd">    &gt;&gt;&gt; from pyscf.shciscf import shci</span>
<span class="sd">    &gt;&gt;&gt; mol = gto.M(atom=&quot;H 0 0 0; H 0 0 2; O 0 1 1;&quot;, symmetry=True)</span>
<span class="sd">    &gt;&gt;&gt; mf = scf.RHF(mol).run()</span>
<span class="sd">    &gt;&gt;&gt; mc = mcscf.CASCI(mf, 3, 4)</span>
<span class="sd">    &gt;&gt;&gt; mc.fcisolver = shci.SHCI(mol)</span>
<span class="sd">    &gt;&gt;&gt; shci.dryrun(mc)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mo_coeff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">mo_coeff</span>

    <span class="c1"># Set orbsym b/c it&#39;s needed in `writeIntegralFile()`</span>
    <span class="k">if</span> <span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">orbsym</span> <span class="ow">is</span> <span class="ow">not</span> <span class="p">[]:</span>
        <span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">orbsym</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="s2">&quot;orbsym&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># mc.kernel(mo_coeff) # Works, but runs full CASCI/CASSCF</span>
    <span class="n">h1e</span><span class="p">,</span> <span class="n">ecore</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">get_h1eff</span><span class="p">(</span><span class="n">mo_coeff</span><span class="p">)</span>
    <span class="n">h2e</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">get_h2eff</span><span class="p">(</span><span class="n">mo_coeff</span><span class="p">)</span>
    <span class="n">writeIntegralFile</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="p">,</span> <span class="n">h1e</span><span class="p">,</span> <span class="n">h2e</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">ncas</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">nelecas</span><span class="p">,</span> <span class="n">ecore</span><span class="p">)</span>
    <span class="n">writeSHCIConfFile</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">nelecas</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<span class="c1"># mc is the CASSCF object</span>
<span class="c1"># nroots is the number of roots that will be used to calcualte the SOC matrix</span>
<span class="k">def</span> <span class="nf">runQDPT</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">gtensor</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;FakeCISolver&quot;</span><span class="p">:</span>
        <span class="n">SHCI</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">fcisolvers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">outFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
        <span class="n">writeSHCIConfFile</span><span class="p">(</span><span class="n">SHCI</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">nelecas</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">confFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SHCI</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">configFile</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">confFile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">SHCI2</span> <span class="ow">in</span> <span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">fcisolvers</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">SHCI2</span><span class="o">.</span><span class="n">scratchDirectory</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;prefix </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SHCI2</span><span class="o">.</span><span class="n">scratchDirectory</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">gtensor</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;dogtensor</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">SHCI</span><span class="o">.</span><span class="n">mpiprefix</span><span class="p">,</span> <span class="n">SHCI</span><span class="o">.</span><span class="n">QDPTexecutable</span><span class="p">,</span> <span class="n">confFile</span><span class="p">))</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2"> 2&gt;&amp;1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">outFile</span><span class="p">)</span>
            <span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">check_call</span><span class="p">(</span><span class="s1">&#39;cat </span><span class="si">%s</span><span class="s1">|grep -v &quot;#&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outFile</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">writeSHCIConfFile</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">nelecas</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">confFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">configFile</span><span class="p">)</span>
        <span class="n">outFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">runtimeDir</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gtensor</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">confFile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;dogtensor</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">mpiprefix</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">QDPTexecutable</span><span class="p">,</span> <span class="n">confFile</span><span class="p">))</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2"> 2&gt;&amp;1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">outFile</span><span class="p">)</span>
            <span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">check_call</span><span class="p">(</span><span class="s1">&#39;cat </span><span class="si">%s</span><span class="s1">|grep -v &quot;#&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outFile</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">fcisolver</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>


<span class="k">def</span> <span class="nf">doSOC</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">gtensor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pictureChange</span><span class="o">=</span><span class="s2">&quot;bp&quot;</span><span class="p">):</span>
    <span class="n">writeSOCIntegrals</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">pictureChange</span><span class="o">=</span><span class="n">pictureChange</span><span class="p">)</span>
    <span class="n">dryrun</span><span class="p">(</span><span class="n">mc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gtensor</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ncore</span><span class="p">,</span> <span class="n">ncas</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">ncore</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">ncas</span>
        <span class="n">h1ao</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">intor</span><span class="p">(</span><span class="s2">&quot;cint1e_cg_irxp_sph&quot;</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;xpq,pi,qj-&gt;xij&quot;</span><span class="p">,</span> <span class="n">h1ao</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)[:,</span> <span class="n">ncore</span><span class="p">:</span><span class="n">ncore</span> <span class="o">+</span> <span class="n">ncas</span><span class="p">,</span> <span class="n">ncore</span><span class="p">:</span><span class="n">ncore</span> <span class="o">+</span> <span class="n">ncas</span><span class="p">]</span>
        <span class="n">print1Int</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="s2">&quot;GTensor&quot;</span><span class="p">)</span>

    <span class="n">runQDPT</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">gtensor</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyscf</span> <span class="kn">import</span> <span class="n">gto</span><span class="p">,</span> <span class="n">scf</span>
    <span class="kn">from</span> <span class="nn">pyscf.shciscf</span> <span class="kn">import</span> <span class="n">shci</span>

    <span class="c1"># Initialize N2 molecule</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.098</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">Mole</span><span class="p">()</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">atom</span><span class="o">=</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.000000</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)],</span>
            <span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.000000</span><span class="p">,</span> <span class="mf">0.000000</span><span class="p">,</span> <span class="n">b</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)],</span>
        <span class="p">],</span>
        <span class="n">basis</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;ccpvdz&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Create HF molecule</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="mf">1e-9</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">scf</span><span class="p">()</span>

    <span class="c1"># Number of orbital and electrons</span>
    <span class="n">norb</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">nelec</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">dimer_atom</span> <span class="o">=</span> <span class="s2">&quot;N&quot;</span>

    <span class="n">mc</span> <span class="o">=</span> <span class="n">mcscf</span><span class="o">.</span><span class="n">CASSCF</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>
    <span class="n">e_CASSCF</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">mc2step</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Create SHCI molecule for just variational opt.</span>
    <span class="c1"># Active spaces chosen to reflect valence active space.</span>
    <span class="n">mch</span> <span class="o">=</span> <span class="n">shci</span><span class="o">.</span><span class="n">SHCISCF</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nelec</span><span class="p">)</span>
    <span class="n">mch</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">nPTiter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Turn off perturbative calc.</span>
    <span class="n">mch</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="s2">&quot;no_PT.dat&quot;</span>
    <span class="n">mch</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">sweep_iter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">mch</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">DoRDM</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Setting large epsilon1 thresholds highlights improvement from perturbation.</span>
    <span class="n">mch</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">sweep_epsilon</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">]</span>
    <span class="n">e_noPT</span> <span class="o">=</span> <span class="n">mch</span><span class="o">.</span><span class="n">mc1step</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Run a single SHCI iteration with perturbative correction.</span>
    <span class="n">mch</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">stochastic</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Turns on deterministic PT calc.</span>
    <span class="n">mch</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="s2">&quot;PT.dat&quot;</span>  <span class="c1"># Save output under different name.</span>
    <span class="n">shci</span><span class="o">.</span><span class="n">writeSHCIConfFile</span><span class="p">(</span><span class="n">mch</span><span class="o">.</span><span class="n">fcisolver</span><span class="p">,</span> <span class="p">[</span><span class="n">nelec</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nelec</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">shci</span><span class="o">.</span><span class="n">executeSHCI</span><span class="p">(</span><span class="n">mch</span><span class="o">.</span><span class="n">fcisolver</span><span class="p">)</span>

    <span class="c1"># Open and get the energy from the binary energy file hci.e.</span>
    <span class="c1"># Open and get the energy from the</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mch</span><span class="o">.</span><span class="n">fcisolver</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">e_PT</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># e_PT = shci.readEnergy( mch.fcisolver )</span>

    <span class="c1"># Comparison Calculations</span>
    <span class="n">del_PT</span> <span class="o">=</span> <span class="n">e_PT</span> <span class="o">-</span> <span class="n">e_noPT</span>
    <span class="n">del_shci</span> <span class="o">=</span> <span class="n">e_CASSCF</span> <span class="o">-</span> <span class="n">e_PT</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Energies for </span><span class="si">%s</span><span class="s2">2 give in E_h.&quot;</span> <span class="o">%</span> <span class="n">dimer_atom</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=====================================&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SHCI Variational: </span><span class="si">%6.12f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e_noPT</span><span class="p">)</span>
    <span class="c1"># Prints the total energy including the perturbative component.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SHCI Perturbative: </span><span class="si">%6.12f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e_PT</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Perturbative Change: </span><span class="si">%6.12f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">del_PT</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CASSCF Total Energy: </span><span class="si">%6.12f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e_CASSCF</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;E(CASSCF) - E(SHCI): </span><span class="si">%6.12f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">del_shci</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2015-2021, The PySCF Developers.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>